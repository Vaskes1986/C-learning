//консольное приложение, принимающее аргументами командной строки входной файл, заданную кодировку и выходной файл в кодировке UTF-8
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <locale.h>
#include <malloc.h>
#include <sys/stat.h>

struct codepage {              //структура кодировок. первые 2 байта -UTF-8; 3- win1251,4 -koi8 , 5- iso8859
	unsigned char utf1;
	unsigned char utf2;
    unsigned char win1251;
	unsigned char koi8;
    unsigned char iso8859;
};

//функция определения размера файла = массива

int fsize (char *filename)
{
	FILE *fin;
	int filesize;
	struct stat buff;
    //открытие файла на чтение
    fin=fopen(filename,"rb");
    printf ("File openning: ");
    if (fin == NULL) {printf ("Error\n"); return -1;}
    else printf ("Done \n");
    //поиск размера файла, для определения размера массива    
    fstat (fileno (fin), &buff);
    filesize=buff.st_size;
    printf ("File size in bytes - %d\n", filesize);
	fclose (fin);
return (filesize);	
}
       
int main(int argc, char** argv)
{
    //кодировка
struct codepage letters[] = {
{0xD0,0x90,0xC0,0xE1,0xB0},{0xD0,0x91,0xC1,0xE2,0xB1},{0xD0,0x92,0xC2,0xF7,0xB2},
{0xD0,0x93,0xC3,0xE7,0xB3},{0xD0,0x94,0xC4,0xE4,0xB4},{0xD0,0x95,0xC5,0xE5,0xB5},
{0xD0,0x96,0xC6,0xF6,0xB6},{0xD0,0x97,0xC7,0xFA,0xB7},{0xD0,0x98,0xC8,0xE9,0xB8},
{0xD0,0x99,0xC9,0xEA,0xB9},{0xD0,0x9A,0xCA,0xEB,0xBA},{0xD0,0x9B,0xCB,0xEC,0xBB},
{0xD0,0x9C,0xCC,0xED,0xBC},{0xD0,0x9D,0xCD,0xEE,0xBD},{0xD0,0x9E,0xCE,0xEF,0xBE},
{0xD0,0x9F,0xCF,0xF0,0xBF},{0xD0,0xA0,0xD0,0xF2,0xC0},{0xD0,0xA1,0xD1,0xF3,0xC1},

{0xD0,0xA2,0xD2,0xF4,0xC2},{0xD0,0xA3,0xD3,0xF5,0xC3},{0xD0,0xA4,0xD4,0xE6,0xC4},
{0xD0,0xA5,0xD5,0xE8,0xC5},{0xD0,0xA6,0xD6,0xE3,0xC6},{0xD0,0xA7,0xD7,0xFE,0xC7},
{0xD0,0xA8,0xD8,0xFB,0xC8},{0xD0,0xA9,0xD9,0xFD,0xC9},{0xD0,0xAA,0xDA,0xFF,0xCA},
{0xD0,0xAB,0xDB,0xF9,0xCB},{0xD0,0xAC,0xDC,0xF8,0xCC},{0xD0,0xAD,0xDD,0xFC,0xCD},
{0xD0,0xAE,0xDE,0xE0,0xCE},{0xD0,0xAF,0xDF,0xF1,0xCF},{0xD0,0xB0,0xE0,0xC1,0xD0},

{0xD0,0xB1,0xE1,0xC2,0xD1},{0xD0,0xB2,0xE2,0xD7,0xD2},{0xD0,0xB3,0xE3,0xC7,0xD3},
{0xD0,0xB4,0xE4,0xC4,0xD4},{0xD0,0xB5,0xE5,0xC5,0xD5},{0xD0,0xB6,0xE6,0xD6,0xD6},
{0xD0,0xB7,0xE7,0xDA,0xD7},{0xD0,0xB8,0xE8,0xC9,0xD8},{0xD0,0xB9,0xE9,0xCA,0xD9},
{0xD0,0xBA,0xEA,0xCB,0xDA},{0xD0,0xBB,0xEB,0xCC,0xDB},{0xD0,0xBC,0xEC,0xCD,0xDC},
{0xD0,0xBD,0xED,0xCE,0xDD},{0xD0,0xBE,0xEE,0xCF,0xDE},{0xD0,0xBF,0xEF,0xD0,0xDF},

{0xD1,0x80,0xF0,0xD2,0xE0},{0xD1,0x81,0xF1,0xD3,0xE1},{0xD1,0x82,0xF2,0xD4,0xE2},
{0xD1,0x83,0xF3,0xD5,0xE3},{0xD1,0x84,0xF4,0xC6,0xE4},{0xD1,0x85,0xF5,0xC8,0xE5},
{0xD1,0x86,0xF6,0xC3,0xE6},{0xD1,0x87,0xF7,0xDE,0xE7},{0xD1,0x88,0xF8,0xDB,0xE8},
{0xD1,0x89,0xF9,0xDD,0xE9},{0xD1,0x8A,0xFA,0xDF,0xEA},{0xD1,0x8B,0xFB,0xD9,0xEB},
{0xD1,0x8C,0xFC,0xD8,0xEC},{0xD1,0x8D,0xFD,0xDC,0xED},{0xD1,0x8E,0xFE,0xC0,0xEE},
{0xD1,0x8F,0xFF,0xD1,0xEF},{0xD1,0x81,0xA8,0xB3,0xA1},{0xD1,0x91,0xB8,0xA3,0xF1}
};
        
    //указатели на файлы + открытие файлов
    FILE *fin=fopen(argv[1],"rb"); //входной
	FILE *fout=fopen(argv[3],"wb"); //выходной

   //запрос имени файла
   printf("Size of command line arguments %d \n", argc);
   printf ("Inputfile name - %s\n", argv[1]);
   printf ("Code type - %s\n", argv[2]);
   printf ("Outputfile name - %s\n", argv[3]);
    int c=fsize(argv[1]); // размер файла
    // Выделение памяти
    unsigned char *a;//массив для входного файла из n по 1 байту (unsignet char -1 byte)   
    a = (unsigned char*)malloc((c) * sizeof(int));    //указывается сначала тип данных массива, затем указывается тип переменной количества эдементов
         
    fread(a,1, c,fin); //fread(имя массива, Размер в байтах каждого считываемого элемента, Количество элементов, файл)
       //определение размера выходного массива
       int i=0;
       int z=0;
       int e=0;
       for (i=0;i<c;i++)
       {
          if (a[i]<0x7F) //определяем количество символов с кодировкой <127
           z++;
        }
        e=2*(c-z)+z;   // в utf-8 после 127 идет двухбайтная кодировка
        printf ("Outputfile size - %d\n", e);
     unsigned char *b;//массив для выходного файла UTF-8 из n по 1 байту (unsignet char -1 byte) 
     b = (unsigned char*)malloc((e) * sizeof(int)); //считывание файла в массив 
	 //перекодировка         
        int j=0;
        int d=0;
        for (i=0;i<c;i++)
        {
            if (a[i]<0x7F)
              {
                b[d]=a[i]; 
                d=d+1;
                }
             else {
              const char *f=argv[2]; //определение типа кодировки
                switch (*f)
                {
                case 'w':
                {for (j=0;j<66;j++) 
                 {
                  if ( a[i]==letters[j].win1251) 
                     {            
                        b[d]=letters[j].utf1;
                        b[d+1]=letters[j].utf2;
                        d=d+2;
                        }}
                break;}
                case 'k':
                {for (j=0;j<66;j++) 
                 {
                  if ( a[i]==letters[j].koi8) 
                     {        
                        b[d]=letters[j].utf1;
                        b[d+1]=letters[j].utf2;
                        d=d+2;
                        }}
                break;}
                case 'i':
                {for (j=0;j<66;j++) 
                 {
                  if ( a[i]==letters[j].iso8859) 
                     {        
                        b[d]=letters[j].utf1;
                        b[d+1]=letters[j].utf2;
                        d=d+2;
                        }}
                break;}
                 }                                         
            }
                		 
	    }   
fwrite(b, 1, e, fout); //запись в файл массив, размер в байт, количество эоементов, файл
fclose (fin);                                      // закрыть файл
fclose (fout);
free(a); //освобождаем память выделенную под массив
free(b);
return 0;
}
